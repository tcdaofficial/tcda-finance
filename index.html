<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TCDA ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Playfair+Display:wght@700;900&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0f1b35;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --cream: #f9f5ed;
    --red: #c0392b;
    --green: #1a6b3c;
    --gray-100: #f4f4f0;
    --gray-200: #e8e5de;
    --gray-400: #9a9590;
    --gray-700: #4a4742;
    --white: #ffffff;
    --shadow: 0 4px 24px rgba(15,27,53,0.12);
    --shadow-lg: 0 12px 48px rgba(15,27,53,0.18);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Sarabun', sans-serif;
    background: var(--cream);
    color: var(--navy);
    min-height: 100vh;
    display: flex;
  }

  /* SIDEBAR */
  .sidebar {
    width: 260px;
    background: var(--navy);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    z-index: 100;
    overflow-y: auto;
  }
  .sidebar-logo {
    padding: 28px 24px 20px;
    border-bottom: 1px solid rgba(201,168,76,0.25);
  }
  .logo-badge {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--gold), #8b6914);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-size: 20px; font-weight: 900; color: white;
    margin-bottom: 12px;
    box-shadow: 0 4px 12px rgba(201,168,76,0.4);
  }
  .logo-title {
    font-family: 'Playfair Display', serif;
    font-size: 14px; font-weight: 700;
    color: var(--gold);
    line-height: 1.3;
    letter-spacing: 0.03em;
  }
  .logo-sub {
    font-size: 10px; color: rgba(201,168,76,0.6);
    margin-top: 2px; letter-spacing: 0.08em; text-transform: uppercase;
  }
  .nav-section { padding: 16px 12px 8px; }
  .nav-label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.12em;
    color: rgba(255,255,255,0.35); text-transform: uppercase;
    padding: 0 12px; margin-bottom: 6px;
  }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 10px;
    cursor: pointer; transition: all 0.2s;
    color: rgba(255,255,255,0.65); font-size: 14px; font-weight: 500;
    margin-bottom: 2px;
  }
  .nav-item:hover { background: rgba(201,168,76,0.12); color: var(--gold-light); }
  .nav-item.active { background: rgba(201,168,76,0.18); color: var(--gold); }
  .nav-item .icon { font-size: 17px; min-width: 20px; text-align: center; }
  .sidebar-footer {
    margin-top: auto; padding: 16px 24px;
    border-top: 1px solid rgba(255,255,255,0.08);
    font-size: 11px; color: rgba(255,255,255,0.3);
  }

  /* MAIN */
  .main {
    margin-left: 260px;
    flex: 1;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .topbar {
    background: white;
    padding: 16px 32px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--gray-200);
    position: sticky; top: 0; z-index: 50;
  }
  .page-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .topbar-actions { display: flex; gap: 10px; align-items: center; }
  .btn {
    padding: 9px 18px; border-radius: 8px; border: none;
    cursor: pointer; font-family: 'Sarabun', sans-serif;
    font-size: 13px; font-weight: 600; transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--gold); color: var(--navy); }
  .btn-primary:hover { background: var(--gold-light); transform: translateY(-1px); box-shadow: var(--shadow); }
  .btn-outline {
    background: transparent; border: 1.5px solid var(--gray-200);
    color: var(--gray-700);
  }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold); }
  .btn-danger { background: var(--red); color: white; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }

  .content { padding: 32px; flex: 1; }

  /* TABS */
  .tabs { display: flex; gap: 4px; margin-bottom: 28px; background: var(--gray-100); border-radius: 12px; padding: 4px; }
  .tab {
    padding: 9px 20px; border-radius: 9px; cursor: pointer;
    font-size: 13px; font-weight: 600; color: var(--gray-400);
    transition: all 0.2s;
  }
  .tab.active { background: white; color: var(--navy); box-shadow: var(--shadow); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* CARDS */
  .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .card {
    background: white; border-radius: 16px; padding: 20px 24px;
    box-shadow: var(--shadow);
  }
  .card-income { border-top: 3px solid var(--green); }
  .card-expense { border-top: 3px solid var(--red); }
  .card-balance { border-top: 3px solid var(--gold); background: linear-gradient(135deg, var(--navy) 0%, #1a2d5a 100%); color: white; }
  .card-pending { border-top: 3px solid #e67e22; }
  .card-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--gray-400); margin-bottom: 8px; }
  .card-balance .card-label { color: rgba(255,255,255,0.5); }
  .card-value { font-family: 'IBM Plex Mono', monospace; font-size: 22px; font-weight: 600; }
  .card-balance .card-value { color: var(--gold); }
  .card-sub { font-size: 12px; color: var(--gray-400); margin-top: 4px; }
  .card-balance .card-sub { color: rgba(255,255,255,0.4); }

  /* TABLE */
  .table-card { background: white; border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
  .table-header {
    padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--gray-100);
  }
  .table-title { font-size: 15px; font-weight: 700; }
  table { width: 100%; border-collapse: collapse; }
  th {
    background: var(--gray-100); text-align: left;
    padding: 11px 16px; font-size: 11px; font-weight: 700;
    letter-spacing: 0.08em; text-transform: uppercase; color: var(--gray-400);
  }
  td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid var(--gray-100); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--gray-100); }
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
  }
  .badge-income { background: #dcf0e5; color: var(--green); }
  .badge-expense { background: #fde8e6; color: var(--red); }
  .badge-paid { background: #dcf0e5; color: var(--green); }
  .badge-pending { background: #fff3e0; color: #e67e22; }
  .badge-draft { background: var(--gray-100); color: var(--gray-400); }
  .amount-income { font-family: 'IBM Plex Mono', monospace; color: var(--green); font-weight: 600; }
  .amount-expense { font-family: 'IBM Plex Mono', monospace; color: var(--red); font-weight: 600; }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,27,53,0.6); backdrop-filter: blur(4px);
    z-index: 200; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: white; border-radius: 20px; padding: 32px;
    width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.25s ease;
  }
  @keyframes slideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; margin-bottom: 24px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; letter-spacing: 0.04em; }
  .form-control {
    width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200);
    border-radius: 10px; font-family: 'Sarabun', sans-serif; font-size: 14px;
    color: var(--navy); transition: border-color 0.2s; background: white;
  }
  .form-control:focus { outline: none; border-color: var(--gold); }
  select.form-control { cursor: pointer; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  /* INVOICE PREVIEW */
  .invoice-preview {
    background: white; border-radius: 16px; box-shadow: var(--shadow);
    overflow: hidden;
  }
  .invoice-topbar {
    background: var(--navy); padding: 20px 32px;
    display: flex; justify-content: space-between; align-items: flex-start;
  }
  .invoice-org { color: white; }
  .invoice-org-name { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: var(--gold); }
  .invoice-org-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
  .invoice-type-badge {
    background: var(--gold); color: var(--navy);
    font-weight: 800; font-size: 13px; letter-spacing: 0.1em;
    padding: 6px 16px; border-radius: 6px; text-transform: uppercase;
  }
  .invoice-body { padding: 32px; }
  .invoice-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 28px; }
  .invoice-meta-item label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--gray-400); display: block; margin-bottom: 4px; }
  .invoice-meta-item span { font-size: 14px; font-weight: 600; }
  .invoice-table th { font-size: 10px; }
  .invoice-total-row {
    display: flex; justify-content: flex-end; margin-top: 20px;
    border-top: 2px solid var(--navy); padding-top: 16px;
  }
  .invoice-total-box { text-align: right; }
  .invoice-total-label { font-size: 12px; color: var(--gray-400); margin-bottom: 4px; }
  .invoice-total-amount { font-family: 'IBM Plex Mono', monospace; font-size: 28px; font-weight: 700; color: var(--navy); }
  .invoice-footer {
    background: var(--gray-100); padding: 16px 32px;
    display: flex; justify-content: space-between;
    font-size: 11px; color: var(--gray-400);
  }
  .invoice-sig { text-align: center; margin-top: 40px; }
  .sig-line { border-top: 1px solid var(--gray-400); width: 180px; margin: 0 auto 6px; }
  .sig-label { font-size: 11px; color: var(--gray-400); }

  /* SEARCH */
  .search-box {
    padding: 9px 14px; border: 1.5px solid var(--gray-200);
    border-radius: 9px; font-family: 'Sarabun', sans-serif; font-size: 13px;
    width: 220px; transition: border-color 0.2s;
  }
  .search-box:focus { outline: none; border-color: var(--gold); }

  /* Filter row */
  .filter-row { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }

  /* Slip card */
  .slip-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .slip-card {
    background: white; border-radius: 14px; padding: 20px;
    box-shadow: var(--shadow); cursor: pointer;
    transition: all 0.2s; border-left: 4px solid var(--gold);
  }
  .slip-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  .slip-card-head { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .slip-no { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--gray-400); }
  .slip-amount { font-family: 'IBM Plex Mono', monospace; font-size: 18px; font-weight: 700; color: var(--navy); }
  .slip-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .slip-date { font-size: 12px; color: var(--gray-400); }

  /* print */
  @media print {
    .sidebar, .topbar, .topbar-actions, .btn, .filter-row, .tabs, .summary-cards,
    .table-card, .modal-overlay { display: none !important; }
    .main { margin: 0; }
    .content { padding: 0; }
    .invoice-preview { box-shadow: none; }
  }

  @media (max-width: 900px) {
    .summary-cards { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-badge">‚ô™</div>
    <div class="logo-title">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á<br>‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
    <div class="logo-sub">Thailand Choral Directors Assoc.</div>
  </div>

  <div class="nav-section">
    <div class="nav-label">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <span class="icon">üìä</span> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
    <div class="nav-item" onclick="showPage('transactions')">
      <span class="icon">üìí</span> ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
    </div>
    <div class="nav-item" onclick="showPage('invoices')">
      <span class="icon">üìÑ</span> ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ / Invoice
    </div>
    <div class="nav-item" onclick="showPage('slips')">
      <span class="icon">üßæ</span> ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô / Slip
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
    <div class="nav-item" onclick="showPage('report')">
      <span class="icon">üìà</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
    </div>
  </div>

  <div class="sidebar-footer">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô TCDA v1.0<br>¬© 2025 ‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏Ø
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
    <div class="topbar-actions">
      <button class="btn btn-outline btn-sm" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
      <button class="btn btn-primary btn-sm" id="addBtn" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="tab-content active">
      <div class="summary-cards">
        <div class="card card-income">
          <div class="card-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
          <div class="card-value" id="totalIncome">‡∏ø0</div>
          <div class="card-sub" id="incomeCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
          <div class="card-value" id="totalExpense">‡∏ø0</div>
          <div class="card-sub" id="expenseCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
          <div class="card-value" id="netBalance">‡∏ø0</div>
          <div class="card-sub">‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        </div>
        <div class="card card-pending">
          <div class="card-label">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</div>
          <div class="card-value" id="pendingAmount">‡∏ø0</div>
          <div class="card-sub" id="pendingCount">0 ‡πÉ‡∏ö</div>
        </div>
      </div>

      <div class="table-card">
        <div class="table-header">
          <div class="table-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <button class="btn btn-outline btn-sm" onclick="showPage('transactions')">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
          </thead>
          <tbody id="recentTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TRANSACTIONS -->
    <div id="page-transactions" class="tab-content">
      <div class="filter-row">
        <input class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="txSearch" oninput="renderTransactions()">
        <select class="form-control" style="width:140px" id="txTypeFilter" onchange="renderTransactions()">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
          <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
          <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        </select>
        <select class="form-control" style="width:160px" id="txCatFilter" onchange="renderTransactions()">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
    </div>

    <!-- INVOICES -->
    <div id="page-invoices" class="tab-content">
      <div class="filter-row">
        <input class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="invSearch" oninput="renderInvoices()">
        <select class="form-control" style="width:140px" id="invStatusFilter" onchange="renderInvoices()">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
          <option value="draft">‡∏£‡πà‡∏≤‡∏á</option>
          <option value="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
          <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="openInvoiceModal()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="invTable"></tbody>
        </table>
      </div>
    </div>

    <!-- SLIPS -->
    <div id="page-slips" class="tab-content">
      <!-- import info box -->
      <div id="importInfoBox" style="background:linear-gradient(135deg,#0f1b35,#1a2d5a);border-radius:14px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;gap:16px">
        <div>
          <div style="color:var(--gold);font-weight:700;font-size:14px;margin-bottom:4px">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Slip ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏à‡∏≤‡∏Å Excel / CSV</div>
          <div style="color:rgba(255,255,255,0.6);font-size:12px">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Excel ‚Üí ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0">
          <button class="btn btn-outline btn-sm" style="color:var(--gold);border-color:var(--gold)" onclick="downloadSlipTemplate()">‚¨áÔ∏è ‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö CSV</button>
          <label class="btn btn-primary btn-sm" style="cursor:pointer">
            üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
            <input type="file" accept=".csv" style="display:none" onchange="importSlipsCSV(this)">
          </label>
        </div>
      </div>
      <div class="filter-row">
        <input class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="slipSearch" oninput="renderSlips()">
        <span id="slipCount" style="font-size:12px;color:var(--gray-400)"></span>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-outline btn-sm" onclick="exportSlipsCSV()">‚¨ÜÔ∏è Export CSV</button>
          <button class="btn btn-primary btn-sm" onclick="openSlipModal()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip</button>
        </div>
      </div>
      <!-- import result toast -->
      <div id="importToast" style="display:none;background:#1a6b3c;color:white;border-radius:10px;padding:12px 20px;margin-bottom:16px;font-size:13px;font-weight:600"></div>
      <div class="slip-list" id="slipList"></div>
    </div>

    <!-- REPORT -->
    <div id="page-report" class="tab-content">
      <div class="summary-cards" style="grid-template-columns: repeat(3,1fr)">
        <div class="card card-income">
          <div class="card-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∞‡∏™‡∏°</div>
          <div class="card-value" id="r-income">‡∏ø0</div>
        </div>
        <div class="card card-expense">
          <div class="card-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div>
          <div class="card-value" id="r-expense">‡∏ø0</div>
        </div>
        <div class="card card-balance">
          <div class="card-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          <div class="card-value" id="r-balance">‡∏ø0</div>
        </div>
      </div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div></div>
        <table>
          <thead>
            <tr><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th><th>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th></tr>
          </thead>
          <tbody id="reportTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</main>

<!-- ADD TRANSACTION MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" class="form-control" id="f-date">
      </div>
      <div class="form-group">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
        <select class="form-control" id="f-type" onchange="updateCategories()">
          <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
          <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
      <input type="text" class="form-control" id="f-desc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <select class="form-control" id="f-cat"></select>
      </div>
      <div class="form-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" class="form-control" id="f-amount" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input type="text" class="form-control" id="f-ref" placeholder="‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('addModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- INVOICE MODAL -->
<div class="modal-overlay" id="invoiceModal">
  <div class="modal" style="width:640px">
    <div class="modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ / Invoice</div>
    <div class="form-row">
      <div class="form-group">
        <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</label>
        <input type="text" class="form-control" id="inv-no" readonly>
      </div>
      <div class="form-group">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
        <input type="date" class="form-control" id="inv-date">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
        <input type="text" class="form-control" id="inv-to" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£">
      </div>
      <div class="form-group">
        <label>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
        <input type="date" class="form-control" id="inv-due">
      </div>
    </div>
    <div class="form-group">
      <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
      <input type="text" class="form-control" id="inv-item" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" class="form-control" id="inv-amount" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
        <select class="form-control" id="inv-status">
          <option value="draft">‡∏£‡πà‡∏≤‡∏á</option>
          <option value="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
          <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input type="text" class="form-control" id="inv-note" placeholder="...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('invoiceModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveInvoice()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- SLIP MODAL -->
<div class="modal-overlay" id="slipModal">
  <div class="modal">
    <div class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</div>
    <div class="form-row">
      <div class="form-group">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</label>
        <input type="date" class="form-control" id="slip-date">
      </div>
      <div class="form-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" class="form-control" id="slip-amount" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô</label>
      <input type="text" class="form-control" id="slip-from" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô">
    </div>
    <div class="form-group">
      <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
      <input type="text" class="form-control" id="slip-desc" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏ö‡∏£‡∏°...">
    </div>
    <div class="form-group">
      <label>‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</label>
      <input type="text" class="form-control" id="slip-ref" placeholder="Transaction ID">
    </div>
    <div class="form-group">
      <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
      <select class="form-control" id="slip-bank">
        <option>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
        <option>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
        <option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
        <option>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
        <option>‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
        <option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)</option>
        <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('slipModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveSlip()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip</button>
    </div>
  </div>
</div>

<!-- INVOICE VIEW MODAL -->
<div class="modal-overlay" id="viewInvoiceModal">
  <div class="modal" style="width:700px; padding:0; overflow:hidden">
    <div id="invoicePreviewContent"></div>
    <div style="padding:16px 24px; display:flex; gap:10px; justify-content:flex-end; background:var(--gray-100); border-top:1px solid var(--gray-200)">
      <button class="btn btn-outline btn-sm" onclick="closeModal('viewInvoiceModal')">‡∏õ‡∏¥‡∏î</button>
      <button class="btn btn-outline btn-sm" onclick="printInvoice()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    </div>
  </div>
</div>

<script>
// ---- DATA STORE ----
let transactions = JSON.parse(localStorage.getItem('tcda_tx') || '[]');
let invoices = JSON.parse(localStorage.getItem('tcda_inv') || '[]');
let slips = JSON.parse(localStorage.getItem('tcda_slips') || '[]');

const incomeCategories = ['‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å','‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏°','‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°','‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ','‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
const expenseCategories = ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£','‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏∑‡πà‡∏≠','‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°','‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á','‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ','‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏Ñ‡∏°','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];

function fmt(n) {
  return '‡∏ø' + parseFloat(n || 0).toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function save() {
  localStorage.setItem('tcda_tx', JSON.stringify(transactions));
  localStorage.setItem('tcda_inv', JSON.stringify(invoices));
  localStorage.setItem('tcda_slips', JSON.stringify(slips));
}
function today() { return new Date().toISOString().split('T')[0]; }
function genInvNo() { return 'INV-' + new Date().getFullYear() + '-' + String(invoices.length + 1).padStart(4,'0'); }
function genSlipNo() { return 'SLP-' + String(slips.length + 1).padStart(4,'0'); }

// ---- NAVIGATION ----
function showPage(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
  const titles = {
    dashboard:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î', transactions:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
    invoices:'‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ / Invoice', slips:'‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô / Slip', report:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ'
  };
  document.getElementById('pageTitle').textContent = titles[id] || id;
  if(id === 'dashboard') renderDashboard();
  if(id === 'transactions') renderTransactions();
  if(id === 'invoices') renderInvoices();
  if(id === 'slips') renderSlips();
  if(id === 'report') renderReport();
}

// ---- MODAL ----
function openAddModal() {
  document.getElementById('f-date').value = today();
  updateCategories();
  document.getElementById('addModal').classList.add('open');
}
function openInvoiceModal() {
  document.getElementById('inv-no').value = genInvNo();
  document.getElementById('inv-date').value = today();
  const due = new Date(); due.setDate(due.getDate() + 30);
  document.getElementById('inv-due').value = due.toISOString().split('T')[0];
  document.getElementById('invoiceModal').classList.add('open');
}
function openSlipModal() {
  document.getElementById('slip-date').value = today();
  document.getElementById('slipModal').classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if(e.target === m) m.classList.remove('open'); });
});

function updateCategories() {
  const type = document.getElementById('f-type').value;
  const cats = type === 'income' ? incomeCategories : expenseCategories;
  const sel = document.getElementById('f-cat');
  sel.innerHTML = cats.map(c => `<option>${c}</option>`).join('');
}
updateCategories();

// ---- SAVE ----
function saveTransaction() {
  const tx = {
    id: Date.now(),
    date: document.getElementById('f-date').value,
    type: document.getElementById('f-type').value,
    desc: document.getElementById('f-desc').value,
    cat: document.getElementById('f-cat').value,
    amount: parseFloat(document.getElementById('f-amount').value) || 0,
    ref: document.getElementById('f-ref').value,
  };
  if(!tx.desc || !tx.amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  transactions.unshift(tx);
  save(); closeModal('addModal');
  document.getElementById('f-desc').value=''; document.getElementById('f-amount').value=''; document.getElementById('f-ref').value='';
  renderDashboard(); renderTransactions();
}

function saveInvoice() {
  const inv = {
    id: Date.now(),
    no: document.getElementById('inv-no').value,
    date: document.getElementById('inv-date').value,
    due: document.getElementById('inv-due').value,
    to: document.getElementById('inv-to').value,
    item: document.getElementById('inv-item').value,
    amount: parseFloat(document.getElementById('inv-amount').value) || 0,
    status: document.getElementById('inv-status').value,
    note: document.getElementById('inv-note').value,
  };
  if(!inv.to || !inv.amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  invoices.unshift(inv);
  save(); closeModal('invoiceModal');
  renderInvoices(); renderDashboard();
}

function saveSlip() {
  const slip = {
    id: Date.now(),
    no: genSlipNo(),
    date: document.getElementById('slip-date').value,
    from: document.getElementById('slip-from').value,
    desc: document.getElementById('slip-desc').value,
    ref: document.getElementById('slip-ref').value,
    bank: document.getElementById('slip-bank').value,
    amount: parseFloat(document.getElementById('slip-amount').value) || 0,
  };
  if(!slip.from || !slip.amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  slips.unshift(slip);
  save(); closeModal('slipModal');
  renderSlips();
}

// ---- RENDER DASHBOARD ----
function renderDashboard() {
  const inc = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const pending = invoices.filter(i=>i.status==='pending').reduce((s,i)=>s+i.amount,0);
  document.getElementById('totalIncome').textContent = fmt(inc);
  document.getElementById('totalExpense').textContent = fmt(exp);
  document.getElementById('netBalance').textContent = fmt(inc - exp);
  document.getElementById('pendingAmount').textContent = fmt(pending);
  document.getElementById('incomeCount').textContent = transactions.filter(t=>t.type==='income').length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('expenseCount').textContent = transactions.filter(t=>t.type==='expense').length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('pendingCount').textContent = invoices.filter(i=>i.status==='pending').length + ' ‡πÉ‡∏ö';

  const recent = transactions.slice(0,8);
  document.getElementById('recentTable').innerHTML = recent.map(t => `
    <tr>
      <td>${t.date}</td>
      <td>${t.desc}</td>
      <td><span style="font-size:12px;color:var(--gray-400)">${t.cat}</span></td>
      <td><span class="badge ${t.type==='income'?'badge-income':'badge-expense'}">${t.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td>
      <td class="${t.type==='income'?'amount-income':'amount-expense'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--gray-400);padding:32px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}

// ---- RENDER TRANSACTIONS ----
function renderTransactions() {
  const q = document.getElementById('txSearch')?.value.toLowerCase() || '';
  const typeF = document.getElementById('txTypeFilter')?.value || '';
  const catF = document.getElementById('txCatFilter')?.value || '';

  // populate cat filter
  const allCats = [...new Set(transactions.map(t=>t.cat))];
  const sel = document.getElementById('txCatFilter');
  if(sel) sel.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>' + allCats.map(c=>`<option ${c===catF?'selected':''}>${c}</option>`).join('');

  let list = transactions.filter(t => {
    if(q && !t.desc.toLowerCase().includes(q) && !t.ref.toLowerCase().includes(q)) return false;
    if(typeF && t.type !== typeF) return false;
    if(catF && t.cat !== catF) return false;
    return true;
  });

  document.getElementById('txTable').innerHTML = list.map(t => `
    <tr>
      <td>${t.date}</td>
      <td><b>${t.desc}</b></td>
      <td><span style="font-size:12px;color:var(--gray-400)">${t.cat}</span></td>
      <td><span class="badge ${t.type==='income'?'badge-income':'badge-expense'}">${t.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td>
      <td style="font-size:12px;color:var(--gray-400)">${t.ref||'-'}</td>
      <td class="${t.type==='income'?'amount-income':'amount-expense'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
      <td><button class="btn btn-outline btn-sm" style="color:var(--red)" onclick="deleteTransaction(${t.id})">‚úï</button></td>
    </tr>
  `).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}

function deleteTransaction(id) {
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  transactions = transactions.filter(t=>t.id!==id);
  save(); renderTransactions(); renderDashboard();
}

// ---- RENDER INVOICES ----
function renderInvoices() {
  const q = document.getElementById('invSearch')?.value.toLowerCase() || '';
  const sf = document.getElementById('invStatusFilter')?.value || '';
  let list = invoices.filter(i => {
    if(q && !i.to.toLowerCase().includes(q) && !i.no.toLowerCase().includes(q)) return false;
    if(sf && i.status !== sf) return false;
    return true;
  });

  document.getElementById('invTable').innerHTML = list.map(i => `
    <tr>
      <td><span style="font-family:'IBM Plex Mono',monospace;font-size:12px">${i.no}</span></td>
      <td>${i.date}</td>
      <td><b>${i.to}</b></td>
      <td>${i.item}</td>
      <td><span class="badge ${i.status==='paid'?'badge-paid':i.status==='pending'?'badge-pending':'badge-draft'}">${i.status==='paid'?'‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß':i.status==='pending'?'‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞':'‡∏£‡πà‡∏≤‡∏á'}</span></td>
      <td class="amount-income">${fmt(i.amount)}</td>
      <td style="display:flex;gap:4px">
        <button class="btn btn-outline btn-sm" onclick="viewInvoice(${i.id})">üëÅÔ∏è ‡∏î‡∏π</button>
        ${i.status!=='paid'?`<button class="btn btn-primary btn-sm" onclick="markPaid(${i.id})">‚úì ‡∏ä‡∏≥‡∏£‡∏∞</button>`:''}
        <button class="btn btn-outline btn-sm" style="color:var(--red)" onclick="deleteInvoice(${i.id})">‚úï</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}

function markPaid(id) {
  const inv = invoices.find(i=>i.id===id);
  if(!inv) return;
  inv.status = 'paid';
  save(); renderInvoices(); renderDashboard();
}
function deleteInvoice(id) {
  if(!confirm('‡∏•‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏µ‡πâ?')) return;
  invoices = invoices.filter(i=>i.id!==id);
  save(); renderInvoices(); renderDashboard();
}

function viewInvoice(id) {
  const inv = invoices.find(i=>i.id===id);
  if(!inv) return;
  document.getElementById('invoicePreviewContent').innerHTML = `
    <div style="background:var(--navy);padding:24px 32px;display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--gold)">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:3px">Thailand Choral Directors Association</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">‡πÇ‡∏ó‡∏£. / ‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏Ø</div>
      </div>
      <div style="background:var(--gold);color:var(--navy);font-weight:800;font-size:14px;letter-spacing:0.1em;padding:8px 20px;border-radius:8px">
        ${inv.status==='paid'?'RECEIPT':'INVOICE'}
      </div>
    </div>
    <div style="padding:28px 32px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
        <div>
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--gray-400);margin-bottom:4px">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
          <div style="font-weight:700;font-size:15px">${inv.to}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;color:var(--gray-400)">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${inv.no}</div>
          <div style="font-size:13px;font-weight:600;margin-top:4px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${inv.date}</div>
          <div style="font-size:12px;color:${inv.status==='paid'?'var(--green)':'var(--red)'};margin-top:2px">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${inv.due}</div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr>
          <th style="background:var(--gray-100);text-align:left;padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:0.06em;color:var(--gray-400)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th style="background:var(--gray-100);text-align:right;padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:0.06em;color:var(--gray-400)">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        </tr></thead>
        <tbody><tr>
          <td style="padding:16px 14px;border-bottom:1px solid var(--gray-100)">${inv.item}</td>
          <td style="padding:16px 14px;border-bottom:1px solid var(--gray-100);text-align:right;font-family:'IBM Plex Mono',monospace;font-weight:600">${fmt(inv.amount)}</td>
        </tr></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:2px solid var(--navy)">
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--gray-400);margin-bottom:4px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:28px;font-weight:700;color:var(--navy)">${fmt(inv.amount)}</div>
        </div>
      </div>
      ${inv.note?`<div style="margin-top:16px;padding:12px 16px;background:var(--gray-100);border-radius:8px;font-size:13px;color:var(--gray-700)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${inv.note}</div>`:''}
      <div style="margin-top:48px;display:grid;grid-template-columns:1fr 1fr;gap:32px">
        <div style="text-align:center">
          <div style="border-top:1px solid var(--gray-400);padding-top:6px;font-size:11px;color:var(--gray-400)">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Receiver</div>
        </div>
        <div style="text-align:center">
          <div style="border-top:1px solid var(--gray-400);padding-top:6px;font-size:11px;color:var(--gray-400)">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô / Payer</div>
        </div>
      </div>
    </div>
    <div style="background:var(--gray-100);padding:14px 32px;display:flex;justify-content:space-between;font-size:11px;color:var(--gray-400)">
      <span>‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</span>
      <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TCDA</span>
    </div>
  `;
  document.getElementById('viewInvoiceModal').classList.add('open');
}
function printInvoice() { window.print(); }

// ---- RENDER SLIPS ----
function renderSlips() {
  const q = document.getElementById('slipSearch')?.value.toLowerCase() || '';
  let list = slips.filter(s => !q || s.from.toLowerCase().includes(q) || s.desc.toLowerCase().includes(q));

  const countEl = document.getElementById('slipCount');
  if(countEl) countEl.textContent = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏° ${slips.length} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`;
  document.getElementById('slipList').innerHTML = list.map(s => `
    <div class="slip-card" onclick="viewSlip(${s.id})">
      <div class="slip-card-head">
        <span class="slip-no">${s.no}</span>
        <span class="badge badge-income">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
      </div>
      <div class="slip-amount">${fmt(s.amount)}</div>
      <div class="slip-name">${s.from}</div>
      <div class="slip-date">${s.date} ¬∑ ${s.bank}</div>
      ${s.desc?`<div style="font-size:12px;color:var(--gray-400);margin-top:6px">${s.desc}</div>`:''}
      ${s.ref?`<div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--gray-400);margin-top:4px">Ref: ${s.ref}</div>`:''}
    </div>
  `).join('') || '<div style="text-align:center;color:var(--gray-400);padding:48px;grid-column:1/-1">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Slip</div>';
}

function viewSlip(id) {
  const s = slips.find(sl=>sl.id===id);
  if(!s) return;
  alert(`Slip: ${s.no}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${s.date}\n‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô: ${s.from}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${fmt(s.amount)}\n‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ${s.bank}\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${s.desc}\n‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${s.ref||'-'}`);
}

// ---- RENDER REPORT ----
function renderReport() {
  const inc = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  document.getElementById('r-income').textContent = fmt(inc);
  document.getElementById('r-expense').textContent = fmt(exp);
  document.getElementById('r-balance').textContent = fmt(inc - exp);

  const catMap = {};
  transactions.forEach(t => {
    const k = t.cat + '_' + t.type;
    if(!catMap[k]) catMap[k] = {cat:t.cat, type:t.type, count:0, total:0};
    catMap[k].count++; catMap[k].total += t.amount;
  });
  document.getElementById('reportTable').innerHTML = Object.values(catMap).sort((a,b)=>b.total-a.total).map(r => `
    <tr>
      <td>${r.cat}</td>
      <td><span class="badge ${r.type==='income'?'badge-income':'badge-expense'}">${r.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td>
      <td>${r.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
      <td class="${r.type==='income'?'amount-income':'amount-expense'}">${fmt(r.total)}</td>
    </tr>
  `).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
}

// ---- CSV IMPORT / EXPORT FOR SLIPS ----

function downloadSlipTemplate() {
  const header = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD),‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå,‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á,‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
  const examples = [
    '2025-03-01,‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ,1500,‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568,2503010001,‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)',
    '2025-03-02,‡∏î‡∏£.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏û‡∏•‡∏á,3000,‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏°,2503020002,‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)',
    '2025-03-03,‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏Ç‡∏±‡∏ö‡∏£‡πâ‡∏≠‡∏á,1500,‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568,,‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)',
  ];
  const csv = '\uFEFF' + header + '\n' + examples.join('\n'); // BOM for Thai Excel
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'TCDA_Slip_Template.csv';
  a.click();
}

function importSlipsCSV(input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result.replace(/^\uFEFF/,''); // strip BOM
    const lines = text.trim().split('\n');
    if(lines.length < 2) return alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

    let imported = 0, errors = [];
    // skip header (line 0)
    for(let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if(!line) continue;
      // handle quoted fields
      const cols = parseCSVLine(line);
      const [date, from, amount, desc, ref, bank] = cols;
      if(!date || !from || !amount) {
        errors.push(`‡πÅ‡∏ñ‡∏ß ${i+1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)`);
        continue;
      }
      const amt = parseFloat(amount.replace(/,/g,''));
      if(isNaN(amt) || amt <= 0) {
        errors.push(`‡πÅ‡∏ñ‡∏ß ${i+1}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á "${amount}"`);
        continue;
      }
      slips.push({
        id: Date.now() + i,
        no: 'SLP-' + String(slips.length + 1).padStart(4,'0'),
        date: date.trim(),
        from: from.trim(),
        amount: amt,
        desc: (desc||'').trim(),
        ref: (ref||'').trim(),
        bank: (bank||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim(),
      });
      imported++;
    }
    save();
    input.value = '';
    const toast = document.getElementById('importToast');
    let msg = `‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${imported} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    if(errors.length) msg += `  ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ ${errors.length} ‡πÅ‡∏ñ‡∏ß: ${errors.slice(0,2).join(', ')}`;
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=>{ toast.style.display='none'; }, 5000);
    renderSlips();
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for(let i = 0; i < line.length; i++) {
    const c = line[i];
    if(c === '"') { inQ = !inQ; }
    else if(c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

function exportSlipsCSV() {
  if(!slips.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Slip');
  const header = '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á,‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
  const rows = slips.map(s =>
    [s.no, s.date, s.from, s.amount, s.desc, s.ref||'', s.bank]
    .map(v => `"${String(v).replace(/"/g,'""')}"`)
    .join(',')
  );
  const csv = '\uFEFF' + header + '\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `TCDA_Slips_Export_${today()}.csv`;
  a.click();
}

// ---- SEED DATA ----
function seedData() {
  if(transactions.length === 0) {
    const d = today();
    transactions = [
      {id:1, date:'2025-01-15', type:'income', desc:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568', cat:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', amount:1500, ref:'TRF001'},
      {id:2, date:'2025-01-20', type:'income', desc:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° Workshop', cat:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏°', amount:3000, ref:'TRF002'},
      {id:3, date:'2025-02-01', type:'expense', desc:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', cat:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', amount:5000, ref:''},
      {id:4, date:'2025-02-10', type:'income', desc:'‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏™‡∏°‡∏≤‡∏Ñ‡∏°', cat:'‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ', amount:10000, ref:'DON001'},
      {id:5, date:'2025-02-15', type:'expense', desc:'‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', cat:'‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£', amount:8000, ref:''},
    ];
    invoices = [
      {id:1, no:'INV-2025-0001', date:'2025-01-10', due:'2025-02-10', to:'‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ', item:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568', amount:1500, status:'paid', note:''},
      {id:2, no:'INV-2025-0002', date:'2025-02-01', due:'2025-03-01', to:'‡∏î‡∏£.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏û‡∏•‡∏á', item:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° Choral Conducting Workshop', amount:3000, status:'pending', note:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏ö‡∏£‡∏°'},
    ];
    slips = [
      {id:1, no:'SLP-0001', date:'2025-01-15', from:'‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ', desc:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568', ref:'2501150001', bank:'‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)', amount:1500},
    ];
    save();
  }
}
seedData();
renderDashboard();
</script>
</body>
</html>
