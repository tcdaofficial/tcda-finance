<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TCDA Finance ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Cormorant+Garamond:wght@600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0e1c38;
  --navy2: #162847;
  --gold: #b8972a;
  --gold-lt: #d4b356;
  --gold-pale: #f5ecd0;
  --cream: #faf8f3;
  --ink: #1a1a2e;
  --green: #1b5e3b;
  --green-lt: #dcf0e5;
  --red: #a8311f;
  --red-lt: #fde8e6;
  --amber: #c07c00;
  --amber-lt: #fff3cc;
  --gray-50: #f8f7f4;
  --gray-100: #eeece6;
  --gray-200: #dedad0;
  --gray-400: #9c9788;
  --gray-600: #6b6760;
  --white: #ffffff;
  --shadow-s: 0 2px 8px rgba(14,28,56,.08);
  --shadow-m: 0 4px 20px rgba(14,28,56,.12);
  --shadow-l: 0 12px 48px rgba(14,28,56,.18);
  --r: 12px;
}
*{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px}
body{font-family:'Sarabun',sans-serif;background:var(--cream);color:var(--ink);display:flex;min-height:100vh}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.sidebar{width:248px;background:var(--navy);flex-shrink:0;display:flex;flex-direction:column;position:fixed;height:100vh;overflow-y:auto;z-index:100}
.sidebar-head{padding:24px 20px 18px;border-bottom:1px solid rgba(184,151,42,.2)}
.org-mark{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.mark-circle{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold-lt),#7a5e10);display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:19px;color:#fff;font-weight:700;flex-shrink:0}
.org-name{font-family:'Cormorant Garamond',serif;font-size:13px;font-weight:700;color:var(--gold-lt);line-height:1.35}
.org-sub{font-size:10px;color:rgba(184,151,42,.55);letter-spacing:.07em;margin-top:6px;line-height:1.5}

.nav-grp{padding:14px 10px 4px}
.nav-grp-label{font-size:9.5px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.28);padding:0 10px;margin-bottom:4px}
.nav-btn{display:flex;align-items:center;gap:9px;width:100%;padding:9px 12px;border-radius:9px;border:none;background:none;cursor:pointer;color:rgba(255,255,255,.55);font-family:'Sarabun',sans-serif;font-size:13.5px;font-weight:500;text-align:left;transition:all .18s;margin-bottom:1px}
.nav-btn:hover{background:rgba(184,151,42,.1);color:rgba(255,255,255,.85)}
.nav-btn.active{background:rgba(184,151,42,.16);color:var(--gold-lt)}
.nav-btn .ni{width:18px;text-align:center;font-size:15px;opacity:.8}
.nav-btn .nbadge{margin-left:auto;background:var(--gold);color:var(--navy);font-size:10px;font-weight:700;padding:1px 7px;border-radius:20px}

.sidebar-foot{margin-top:auto;padding:14px 20px;border-top:1px solid rgba(255,255,255,.06);font-size:10.5px;color:rgba(255,255,255,.25);line-height:1.6}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.main{margin-left:248px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:var(--white);border-bottom:1px solid var(--gray-100);padding:14px 28px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50}
.topbar-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;flex:1}
.content{padding:24px 28px;flex:1}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-family:'Sarabun',sans-serif;font-size:13px;font-weight:600;transition:all .18s;white-space:nowrap}
.btn-primary{background:var(--gold);color:var(--navy)}
.btn-primary:hover{background:var(--gold-lt);box-shadow:var(--shadow-m);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1.5px solid var(--gray-200);color:var(--gray-600)}
.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-ghost{background:transparent;color:var(--gray-600)}
.btn-ghost:hover{background:var(--gray-50)}
.btn-danger{background:var(--red);color:white}
.btn-success{background:var(--green);color:white}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-xs{padding:4px 9px;font-size:11px}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.stat-card{background:var(--white);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow-s);border-top:3px solid transparent}
.stat-income{border-color:var(--green)}
.stat-expense{border-color:var(--red)}
.stat-balance{border-color:var(--gold);background:var(--navy)}
.stat-pending{border-color:var(--amber)}
.stat-label{font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--gray-400);margin-bottom:6px}
.stat-balance .stat-label{color:rgba(255,255,255,.4)}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600}
.stat-balance .stat-val{color:var(--gold-lt)}
.stat-sub{font-size:11px;color:var(--gray-400);margin-top:3px}
.stat-balance .stat-sub{color:rgba(255,255,255,.3)}

/* ‚îÄ‚îÄ TABLE CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.tcard{background:var(--white);border-radius:var(--r);box-shadow:var(--shadow-s);overflow:hidden;margin-bottom:18px}
.tcard-head{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--gray-50)}
.tcard-title{font-size:14px;font-weight:700}
table{width:100%;border-collapse:collapse}
th{background:var(--gray-50);padding:9px 14px;text-align:left;font-size:10.5px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--gray-400)}
td{padding:12px 14px;font-size:13px;border-bottom:1px solid var(--gray-50)}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--gray-50)}
.mono{font-family:'JetBrains Mono',monospace}
.c-green{color:var(--green);font-weight:600}
.c-red{color:var(--red);font-weight:600}
.c-gold{color:var(--gold)}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:700}
.b-income{background:var(--green-lt);color:var(--green)}
.b-expense{background:var(--red-lt);color:var(--red)}
.b-paid{background:var(--green-lt);color:var(--green)}
.b-pending{background:var(--amber-lt);color:var(--amber)}
.b-draft{background:var(--gray-100);color:var(--gray-400)}
.b-overdue{background:var(--red-lt);color:var(--red)}
.b-tax{background:var(--gold-pale);color:var(--gold)}

/* ‚îÄ‚îÄ FILTER ROW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.filter-row{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.search-inp{padding:8px 13px;border:1.5px solid var(--gray-200);border-radius:8px;font-family:'Sarabun',sans-serif;font-size:13px;width:210px;transition:border-color .18s;background:var(--white)}
.search-inp:focus{outline:none;border-color:var(--gold)}
select.sel{padding:8px 12px;border:1.5px solid var(--gray-200);border-radius:8px;font-family:'Sarabun',sans-serif;font-size:13px;color:var(--ink);background:var(--white);cursor:pointer;transition:border-color .18s}
select.sel:focus{outline:none;border-color:var(--gold)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(14,28,56,.55);backdrop-filter:blur(5px);z-index:200;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:var(--white);border-radius:16px;width:600px;max-width:98vw;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-l);animation:mup .22s ease}
@keyframes mup{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-head{padding:24px 28px 0;display:flex;align-items:flex-start;justify-content:space-between}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:21px;font-weight:700}
.modal-close{background:none;border:none;cursor:pointer;font-size:20px;color:var(--gray-400);padding:4px;border-radius:6px;line-height:1}
.modal-close:hover{background:var(--gray-100)}
.modal-body{padding:20px 28px}
.modal-foot{padding:16px 28px;border-top:1px solid var(--gray-100);display:flex;gap:8px;justify-content:flex-end;background:var(--gray-50)}

/* FORM */
.fg{margin-bottom:14px}
.fg label{display:block;font-size:11.5px;font-weight:700;color:var(--gray-600);margin-bottom:5px;letter-spacing:.03em}
.fc{width:100%;padding:9px 13px;border:1.5px solid var(--gray-200);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:14px;color:var(--ink);transition:border-color .18s;background:var(--white)}
.fc:focus{outline:none;border-color:var(--gold)}
.fc-mono{font-family:'JetBrains Mono',monospace;font-size:13px}
.frow{display:grid;gap:14px;margin-bottom:14px}
.frow-2{grid-template-columns:1fr 1fr}
.frow-3{grid-template-columns:1fr 1fr 1fr}
.fdivider{height:1px;background:var(--gray-100);margin:18px 0}
.fsection-title{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);margin-bottom:12px}

/* STEPS (Flow-style) */
.steps{display:flex;gap:0;margin-bottom:24px;border-radius:10px;overflow:hidden;border:1px solid var(--gray-200)}
.step{flex:1;padding:10px 14px;text-align:center;background:var(--white);cursor:pointer;transition:all .18s;position:relative;font-size:12px;font-weight:600;color:var(--gray-400)}
.step+.step{border-left:1px solid var(--gray-200)}
.step.done{background:var(--green-lt);color:var(--green)}
.step.active{background:var(--navy);color:var(--gold-lt)}
.step-num{font-family:'JetBrains Mono',monospace;font-size:10px;display:block;margin-bottom:2px;opacity:.6}

/* INVOICE PRINT */
.inv-preview{font-family:'Sarabun',sans-serif}
.inv-header{background:var(--navy);padding:24px 32px;display:flex;justify-content:space-between;align-items:flex-start}
.inv-org-name{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:700;color:var(--gold-lt)}
.inv-org-detail{font-size:11px;color:rgba(255,255,255,.45);margin-top:3px;line-height:1.7}
.inv-doc-type{text-align:right}
.inv-doc-label{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--white)}
.inv-doc-label-th{font-size:13px;color:var(--gold-lt);font-weight:600}
.inv-doc-no{font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(255,255,255,.5);margin-top:4px}
.inv-body{padding:28px 32px}
.inv-meta{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.inv-meta-box{background:var(--gray-50);border-radius:9px;padding:14px 16px}
.inv-meta-label{font-size:9.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);margin-bottom:6px}
.inv-meta-val{font-size:13px;font-weight:600;line-height:1.5}
.inv-meta-val-sm{font-size:12px;color:var(--gray-600);line-height:1.6}
.inv-items table th{background:var(--navy);color:rgba(255,255,255,.7)}
.inv-items table td{vertical-align:top}
.inv-totals{margin-top:16px;display:flex;justify-content:flex-end}
.inv-totals-box{width:260px}
.inv-tot-row{display:flex;justify-content:space-between;padding:5px 0;font-size:13px}
.inv-tot-row.total-final{border-top:2px solid var(--navy);margin-top:6px;padding-top:10px;font-weight:700;font-size:16px}
.inv-tot-row .amt{font-family:'JetBrains Mono',monospace}
.inv-footer{background:var(--gray-50);padding:14px 32px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.inv-sig-box{text-align:center;padding-top:40px}
.inv-sig-line{border-top:1px solid var(--gray-400);margin-bottom:6px}
.inv-sig-label{font-size:11px;color:var(--gray-400)}
.inv-note-box{background:var(--amber-lt);border-left:3px solid var(--amber);border-radius:0 6px 6px 0;padding:10px 14px;margin-top:16px;font-size:12px;color:var(--amber)}
.inv-stamp{display:inline-block;border:3px solid var(--green);color:var(--green);border-radius:50%;width:72px;height:72px;line-height:66px;text-align:center;font-weight:800;font-size:12px;transform:rotate(-15deg);letter-spacing:.05em;margin-top:-10px}
.inv-watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:.04;font-family:'Cormorant Garamond',serif;font-size:90px;font-weight:700;color:var(--navy);transform:rotate(-30deg)}

/* SLIP LIST */
.slip-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.slip-card{background:var(--white);border-radius:var(--r);padding:18px;box-shadow:var(--shadow-s);border-left:4px solid var(--gold);cursor:pointer;transition:all .18s}
.slip-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-m)}
.slip-no{font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--gray-400)}
.slip-amt{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--navy);margin:6px 0 2px}
.slip-from{font-size:13.5px;font-weight:600}
.slip-meta{font-size:11.5px;color:var(--gray-400);margin-top:3px}

/* IMPORT BOX */
.import-box{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);border-radius:var(--r);padding:18px 22px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
.import-box-text h4{color:var(--gold-lt);font-size:13.5px;font-weight:700;margin-bottom:3px}
.import-box-text p{color:rgba(255,255,255,.5);font-size:11.5px}
.import-box-btns{display:flex;gap:8px;flex-shrink:0}
.btn-ghost-gold{background:transparent;border:1.5px solid rgba(184,151,42,.5);color:var(--gold-lt)}
.btn-ghost-gold:hover{border-color:var(--gold-lt);background:rgba(184,151,42,.08)}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;padding:13px 20px;border-radius:10px;font-size:13px;font-weight:600;box-shadow:var(--shadow-l);z-index:9999;animation:mup .25s ease;max-width:380px}
.toast-ok{background:var(--green);color:white}
.toast-err{background:var(--red);color:white}

/* TABS */
.tabs{display:flex;gap:3px;background:var(--gray-100);border-radius:10px;padding:3px;margin-bottom:20px}
.tab-btn{padding:8px 18px;border-radius:8px;border:none;background:none;cursor:pointer;font-family:'Sarabun',sans-serif;font-size:13px;font-weight:600;color:var(--gray-400);transition:all .18s}
.tab-btn.active{background:var(--white);color:var(--navy);box-shadow:var(--shadow-s)}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* SECTION */
.page{display:none}
.page.active{display:block}

/* Google Sheet sync UI */
.gsheet-bar{background:var(--white);border:1.5px solid var(--gray-200);border-radius:var(--r);padding:14px 18px;display:flex;align-items:center;gap:12px;margin-bottom:18px}
.gsheet-logo{width:28px;height:28px;flex-shrink:0}
.gsheet-info{flex:1}
.gsheet-info h5{font-size:13px;font-weight:700;margin-bottom:1px}
.gsheet-info p{font-size:11.5px;color:var(--gray-400)}
.gsheet-status{font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}
.gs-connected{background:var(--green-lt);color:var(--green)}
.gs-disconnected{background:var(--gray-100);color:var(--gray-400)}
.gsheet-url-row{display:flex;gap:8px;margin-top:10px}
.gsheet-url-row input{flex:1}

/* Report chart */
.bar-chart{display:flex;flex-direction:column;gap:8px;padding:18px 20px}
.bar-row{display:flex;align-items:center;gap:10px}
.bar-label{font-size:12px;width:160px;flex-shrink:0;color:var(--gray-600)}
.bar-track{flex:1;height:10px;background:var(--gray-100);border-radius:20px;overflow:hidden}
.bar-fill{height:100%;border-radius:20px;transition:width .6s ease}
.bar-income-fill{background:var(--green)}
.bar-expense-fill{background:var(--red)}
.bar-amt{font-family:'JetBrains Mono',monospace;font-size:11.5px;width:110px;text-align:right;flex-shrink:0}

@media print{
  .sidebar,.topbar,.filter-row,.import-box,.gsheet-bar,.btn,.tabs,.stat-grid,.tcard:not(.print-target){display:none!important}
  .main{margin:0}
  .content{padding:0}
  .inv-preview{box-shadow:none}
  .overlay.open{background:none;backdrop-filter:none;position:static;display:block;padding:0}
  .modal{box-shadow:none;border-radius:0;max-height:none;width:100%}
  .modal-head,.modal-foot,.overlay > .modal > .modal-head,.overlay > .modal > .modal-foot{display:none!important}
  #printArea{display:block!important}
}
#printArea{display:none}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-head">
    <div class="org-mark">
      <div class="mark-circle">‚ô™</div>
      <div class="org-name">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á<br>‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</div>
    </div>
    <div class="org-sub">Thailand Choral Directors Association<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô v2.0</div>
  </div>

  <div class="nav-grp">
    <div class="nav-grp-label">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
    <button class="nav-btn active" onclick="nav('dashboard',this)"><span class="ni">üìä</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
  </div>
  <div class="nav-grp">
    <div class="nav-grp-label">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
    <button class="nav-btn" onclick="nav('transactions',this)"><span class="ni">üìí</span>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="nav-btn" id="nav-invoices" onclick="nav('invoices',this)"><span class="ni">üìÑ</span>Invoice / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
    <button class="nav-btn" id="nav-taxinvoice" onclick="nav('taxinvoice',this)"><span class="ni">üßæ</span>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</button>
    <button class="nav-btn" onclick="nav('receipts',this)"><span class="ni">‚úÖ</span>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
    <button class="nav-btn" onclick="nav('slips',this)"><span class="ni">üí∏</span>Slip ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
  </div>
  <div class="nav-grp">
    <div class="nav-grp-label">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <button class="nav-btn" onclick="nav('gsheet',this)"><span class="ni">üìó</span>Google Sheets</button>
  </div>
  <div class="nav-grp">
    <div class="nav-grp-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
    <button class="nav-btn" onclick="nav('report',this)"><span class="ni">üìà</span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
  </div>

  <div class="sidebar-foot">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á<br>¬© 2025 ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö TCDA Finance v2</div>
</aside>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
    <button class="btn btn-ghost btn-sm" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    <button class="btn btn-primary btn-sm" id="topAddBtn" onclick="openTxModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="content">

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="page active" id="page-dashboard">
      <div class="stat-grid" id="statGrid"></div>
      <div class="tcard">
        <div class="tcard-head"><span class="tcard-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span><button class="btn btn-ghost btn-sm" onclick="nav('transactions',document.querySelector('.nav-btn'))">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</button></div>
        <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
        <tbody id="recentRows"></tbody></table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ -->
    <div class="page" id="page-transactions">
      <div class="filter-row">
        <input class="search-inp" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="txQ" oninput="renderTx()">
        <select class="sel" id="txType" onchange="renderTx()"><option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option><option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select>
        <select class="sel" id="txCat" onchange="renderTx()"><option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option></select>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-outline btn-sm" onclick="exportTxCSV()">‚¨ÜÔ∏è Export</button>
          <label class="btn btn-outline btn-sm" style="cursor:pointer">üì• Import CSV<input type="file" accept=".csv" style="display:none" onchange="importTxCSV(this)"></label>
          <button class="btn btn-primary btn-sm" onclick="openTxModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
      <div class="tcard">
        <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th><th class="mono">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th></th></tr></thead>
        <tbody id="txRows"></tbody></table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ INVOICES ‚îÄ‚îÄ -->
    <div class="page" id="page-invoices">
      <div class="filter-row">
        <input class="search-inp" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="invQ" oninput="renderInv()">
        <select class="sel" id="invStatus" onchange="renderInv()"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="draft">‡∏£‡πà‡∏≤‡∏á</option><option value="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option><option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option></select>
        <div style="margin-left:auto"><button class="btn btn-primary btn-sm" onclick="openInvWizard()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice</button></div>
      </div>
      <div class="tcard">
        <table><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="mono">‡∏¢‡∏≠‡∏î</th><th></th></tr></thead>
        <tbody id="invRows"></tbody></table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAX INVOICE ‚îÄ‚îÄ -->
    <div class="page" id="page-taxinvoice">
      <div class="filter-row">
        <input class="search-inp" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="taxQ" oninput="renderTax()">
        <select class="sel" id="taxStatus" onchange="renderTax()"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="draft">‡∏£‡πà‡∏≤‡∏á</option><option value="issued">‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option></select>
        <div style="margin-left:auto"><button class="btn btn-primary btn-sm" onclick="openTaxWizard()">+ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</button></div>
      </div>
      <div class="tcard">
        <table><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="mono">‡∏Å‡πà‡∏≠‡∏ô VAT</th><th class="mono">VAT 7%</th><th class="mono">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th></th></tr></thead>
        <tbody id="taxRows"></tbody></table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ RECEIPTS ‚îÄ‚îÄ -->
    <div class="page" id="page-receipts">
      <div class="filter-row">
        <input class="search-inp" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="recQ" oninput="renderRec()">
        <div style="margin-left:auto"><button class="btn btn-primary btn-sm" onclick="openRecWizard()">+ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button></div>
      </div>
      <div class="tcard">
        <table><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="mono">‡∏¢‡∏≠‡∏î</th><th></th></tr></thead>
        <tbody id="recRows"></tbody></table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SLIPS ‚îÄ‚îÄ -->
    <div class="page" id="page-slips">
      <div class="import-box">
        <div class="import-box-text">
          <h4>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Slip ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏à‡∏≤‡∏Å Excel / CSV</h4>
          <p>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Excel ‚Üí ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
        </div>
        <div class="import-box-btns">
          <button class="btn btn-ghost-gold btn-sm" onclick="dlSlipTemplate()">‚¨áÔ∏è ‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö</button>
          <label class="btn btn-primary btn-sm" style="cursor:pointer">üìÇ Import CSV<input type="file" accept=".csv" style="display:none" onchange="importSlips(this)"></label>
          <button class="btn btn-ghost-gold btn-sm" onclick="exportSlips()">‚¨ÜÔ∏è Export</button>
        </div>
      </div>
      <div class="filter-row">
        <input class="search-inp" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="slipQ" oninput="renderSlips()">
        <span id="slipCountLbl" style="font-size:12px;color:var(--gray-400)"></span>
        <div style="margin-left:auto"><button class="btn btn-primary btn-sm" onclick="openSlipModal()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip</button></div>
      </div>
      <div class="slip-grid" id="slipGrid"></div>
    </div>

    <!-- ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ -->
    <div class="page" id="page-gsheet">
      <div class="tcard" style="padding:0">
        <div class="tcard-head"><span class="tcard-title">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</span></div>
        <div style="padding:20px 24px">
          <div class="gsheet-bar">
            <svg class="gsheet-logo" viewBox="0 0 48 48"><rect width="48" height="48" rx="6" fill="#0F9D58"/><path d="M16 13h16v4H16zm0 8h16v4H16zm0 8h10v4H16z" fill="white" opacity=".9"/></svg>
            <div class="gsheet-info">
              <h5>Google Sheets Sync</h5>
              <p id="gsStatusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‚Äî ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Sheet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
            </div>
            <span class="gsheet-status gs-disconnected" id="gsBadge">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°</span>
          </div>

          <div class="fsection-title">Google Sheet URL (Publish to Web)</div>
          <div style="background:var(--amber-lt);border-radius:8px;padding:12px 16px;margin-bottom:14px;font-size:12.5px;color:var(--amber);line-height:1.7">
            <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet:</b><br>
            1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚Üí <b>File ‚Üí Share ‚Üí Publish to web</b><br>
            2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚Üí Format: <b>CSV</b> ‚Üí ‡∏Å‡∏î Publish ‚Üí Copy ‡∏•‡∏¥‡∏á‡∏Å‡πå<br>
            3. ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞ Import</b>
          </div>
          <div class="fg">
            <label>URL ‡∏Ç‡∏≠‡∏á Sheet ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (CSV)</label>
            <div class="gsheet-url-row">
              <input class="fc" id="gsTxUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
              <button class="btn btn-primary btn-sm" onclick="importFromGSheet('tx')">üì• Import ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢</button>
            </div>
          </div>
          <div class="fg">
            <label>URL ‡∏Ç‡∏≠‡∏á Sheet Slip (CSV)</label>
            <div class="gsheet-url-row">
              <input class="fc" id="gsSlipUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
              <button class="btn btn-primary btn-sm" onclick="importFromGSheet('slip')">üì• Import Slips</button>
            </div>
          </div>
          <div class="fdivider"></div>
          <div class="fsection-title">Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ Google Sheets</div>
          <p style="font-size:12.5px;color:var(--gray-400);margin-bottom:14px">Download CSV ‡πÅ‡∏•‡πâ‡∏ß Import ‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (File ‚Üí Import)</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-outline btn-sm" onclick="exportTxCSV()">‚¨ÜÔ∏è Export ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (.csv)</button>
            <button class="btn btn-outline btn-sm" onclick="exportSlips()">‚¨ÜÔ∏è Export Slips (.csv)</button>
            <button class="btn btn-outline btn-sm" onclick="exportInvCSV()">‚¨ÜÔ∏è Export Invoices (.csv)</button>
            <button class="btn btn-outline btn-sm" onclick="exportTaxCSV()">‚¨ÜÔ∏è Export ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (.csv)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ -->
    <div class="page" id="page-report">
      <div class="stat-grid" id="rStatGrid" style="grid-template-columns:repeat(3,1fr)"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="tcard">
          <div class="tcard-head"><span class="tcard-title">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</span></div>
          <div class="bar-chart" id="incomeChart"></div>
        </div>
        <div class="tcard">
          <div class="tcard-head"><span class="tcard-title">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</span></div>
          <div class="bar-chart" id="expenseChart"></div>
        </div>
      </div>
      <div class="tcard" style="margin-top:16px">
        <div class="tcard-head"><span class="tcard-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></div>
        <table><thead><tr><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th><th class="mono">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
        <tbody id="reportRows"></tbody></table>
      </div>
    </div>

  </div><!-- /content -->
</main>

<!-- print target -->
<div id="printArea"></div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->

<!-- ADD TRANSACTION -->
<div class="overlay" id="txModal">
  <div class="modal" style="width:540px">
    <div class="modal-head"><div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div><button class="modal-close" onclick="closeM('txModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="frow frow-2">
        <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="fc" id="f-date"></div>
        <div class="fg"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select class="fc" id="f-type" onchange="updateTxCats()"><option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></div>
      </div>
      <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" class="fc" id="f-desc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..."></div>
      <div class="frow frow-2">
        <div class="fg"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select class="fc" id="f-cat"></select></div>
        <div class="fg"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="fc fc-mono" id="f-amount" placeholder="0.00" min="0"></div>
      </div>
      <div class="fg"><label>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="fc" id="f-ref" placeholder="‡πÄ‡∏•‡∏Ç‡πÇ‡∏≠‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô..."></div>
    </div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="closeM('txModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-primary" onclick="saveTx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
  </div>
</div>

<!-- INVOICE WIZARD -->
<div class="overlay" id="invModal">
  <div class="modal" style="width:620px">
    <div class="modal-head"><div class="modal-title" id="invModalTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice ‡πÉ‡∏´‡∏°‡πà</div><button class="modal-close" onclick="closeM('invModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="steps" id="invSteps">
        <div class="step active" data-s="0"><span class="step-num">01</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
        <div class="step" data-s="1"><span class="step-num">02</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="step" data-s="2"><span class="step-num">03</span>‡∏™‡∏£‡∏∏‡∏õ</div>
      </div>
      <!-- Step 0 -->
      <div id="inv-s0">
        <div class="frow frow-2">
          <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Invoice</label><input type="text" class="fc fc-mono" id="inv-no" readonly></div>
          <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label><input type="date" class="fc" id="inv-date"></div>
        </div>
        <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö / ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label><input type="text" class="fc" id="inv-to" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£"></div>
        <div class="frow frow-2">
          <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label><input type="date" class="fc" id="inv-due"></div>
          <div class="fg"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select class="fc" id="inv-status"><option value="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option><option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option><option value="draft">‡∏£‡πà‡∏≤‡∏á</option></select></div>
        </div>
      </div>
      <!-- Step 1 -->
      <div id="inv-s1" style="display:none">
        <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><input type="text" class="fc" id="inv-item" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..."></div>
        <div class="frow frow-2">
          <div class="fg"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="fc fc-mono" id="inv-amount" placeholder="0.00" oninput="calcInvTotal()"></div>
          <div class="fg"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="fc" id="inv-note" placeholder="..."></div>
        </div>
      </div>
      <!-- Step 2 -->
      <div id="inv-s2" style="display:none">
        <div style="background:var(--gray-50);border-radius:10px;padding:18px">
          <div id="inv-preview-mini" style="font-size:13px;line-height:2"></div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:16px" id="invStepNav">
        <button class="btn btn-ghost" id="invBack" onclick="invStep(-1)" style="visibility:hidden">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn btn-primary" id="invNext" onclick="invStep(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- TAX INVOICE WIZARD -->
<div class="overlay" id="taxModal">
  <div class="modal" style="width:640px">
    <div class="modal-head"><div class="modal-title">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</div><button class="modal-close" onclick="closeM('taxModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="fsection-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏Ø)</div>
      <div class="frow frow-2">
        <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</label><input type="text" class="fc fc-mono" id="tax-no" readonly></div>
        <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label><input type="date" class="fc" id="tax-date"></div>
      </div>
      <div class="frow frow-2">
        <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏°‡∏≤‡∏Ñ‡∏°</label><input type="text" class="fc fc-mono" id="tax-seller-id" placeholder="1-2345-67890-12-3"></div>
        <div class="fg"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</label>
          <select class="fc" id="tax-doc-type">
            <option value="full">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</option>
            <option value="short">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</option>
          </select>
        </div>
      </div>
      <div class="fdivider"></div>
      <div class="fsection-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
      <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label><input type="text" class="fc" id="tax-buyer" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£"></div>
      <div class="frow frow-2">
        <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label><input type="text" class="fc fc-mono" id="tax-buyer-id" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å"></div>
        <div class="fg"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label><input type="text" class="fc" id="tax-buyer-addr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö"></div>
      </div>
      <div class="fdivider"></div>
      <div class="fsection-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
      <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" class="fc" id="tax-item" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..."></div>
      <div class="frow frow-3">
        <div class="fg"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô VAT (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="fc fc-mono" id="tax-before" placeholder="0.00" oninput="calcVat()"></div>
        <div class="fg"><label>VAT 7%</label><input type="text" class="fc fc-mono" id="tax-vat" readonly placeholder="0.00" style="background:var(--gray-50)"></div>
        <div class="fg"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</label><input type="text" class="fc fc-mono" id="tax-total" readonly placeholder="0.00" style="background:var(--gray-50);font-weight:700"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeM('taxModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-outline" onclick="saveTaxDoc('draft')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á</button>
      <button class="btn btn-primary" onclick="saveTaxDoc('issued')">‚úÖ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</button>
    </div>
  </div>
</div>

<!-- RECEIPT WIZARD -->
<div class="overlay" id="recModal">
  <div class="modal" style="width:560px">
    <div class="modal-head"><div class="modal-title">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><button class="modal-close" onclick="closeM('recModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="frow frow-2">
        <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="text" class="fc fc-mono" id="rec-no" readonly></div>
        <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label><input type="date" class="fc" id="rec-date"></div>
      </div>
      <div class="fg"><label>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å</label><input type="text" class="fc" id="rec-from" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"></div>
      <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" class="fc" id="rec-item" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..."></div>
      <div class="frow frow-2">
        <div class="fg"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="fc fc-mono" id="rec-amount" placeholder="0.00"></div>
        <div class="fg"><label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
          <select class="fc" id="rec-method">
            <option>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option><option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option><option>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
      </div>
      <div class="fg"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="fc" id="rec-note" placeholder="‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Invoice, ‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏¥‡∏õ..."></div>
    </div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="closeM('recModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-primary" onclick="saveRec()">‚úÖ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button></div>
  </div>
</div>

<!-- SLIP MODAL -->
<div class="overlay" id="slipModal">
  <div class="modal" style="width:520px">
    <div class="modal-head"><div class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</div><button class="modal-close" onclick="closeM('slipModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="frow frow-2">
        <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</label><input type="date" class="fc" id="sl-date"></div>
        <div class="fg"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="fc fc-mono" id="sl-amount" placeholder="0.00"></div>
      </div>
      <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô</label><input type="text" class="fc" id="sl-from" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
      <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label><input type="text" class="fc" id="sl-desc" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..."></div>
      <div class="frow frow-2">
        <div class="fg"><label>‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</label><input type="text" class="fc fc-mono" id="sl-ref" placeholder="Transaction ID"></div>
        <div class="fg"><label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
          <select class="fc" id="sl-bank">
            <option>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option><option>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option><option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
            <option>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option><option>‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option><option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="closeM('slipModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-primary" onclick="saveSlip()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
  </div>
</div>

<!-- DOC VIEW MODAL -->
<div class="overlay" id="docViewModal">
  <div class="modal" style="width:720px;padding:0;overflow:hidden">
    <div id="docViewContent"></div>
    <div style="padding:12px 20px;display:flex;gap:8px;justify-content:flex-end;background:var(--gray-50);border-top:1px solid var(--gray-100)">
      <button class="btn btn-ghost btn-sm" onclick="closeM('docViewModal')">‡∏õ‡∏¥‡∏î</button>
      <button class="btn btn-outline btn-sm" onclick="printDoc()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DB = {
  tx:   JSON.parse(localStorage.getItem('tcda2_tx')   || '[]'),
  inv:  JSON.parse(localStorage.getItem('tcda2_inv')  || '[]'),
  tax:  JSON.parse(localStorage.getItem('tcda2_tax')  || '[]'),
  rec:  JSON.parse(localStorage.getItem('tcda2_rec')  || '[]'),
  slip: JSON.parse(localStorage.getItem('tcda2_slip') || '[]'),
  cfg:  JSON.parse(localStorage.getItem('tcda2_cfg')  || '{"sellerTaxId":"","gsTxUrl":"","gsSlipUrl":""}'),
};
function save(){ for(const k in DB) localStorage.setItem('tcda2_'+k, JSON.stringify(DB[k])); }

const incomeCats = ['‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å','‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏°','‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°','‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ','‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
const expenseCats= ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£','‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏∑‡πà‡∏≠','‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á','‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ','‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏Ñ‡∏°','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];

const fmt = n => '‡∏ø'+parseFloat(n||0).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});
const today = () => new Date().toISOString().split('T')[0];
const uid = () => Date.now()+Math.random().toString(36).slice(2,6);
const seq = (arr,prefix) => prefix+'-'+new Date().getFullYear()+'-'+String(arr.length+1).padStart(4,'0');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pageTitles = {dashboard:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',transactions:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',invoices:'Invoice / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',taxinvoice:'‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ',receipts:'‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',slips:'Slip ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô',gsheet:'Google Sheets Sync',report:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ'};
const addBtnLabels = {transactions:'+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',invoices:'+ Invoice',taxinvoice:'+ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ',receipts:'+ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à',slips:'+ Slip'};
const addBtnFns = {transactions:'openTxModal()',invoices:'openInvWizard()',taxinvoice:'openTaxWizard()',receipts:'openRecWizard()',slips:"openSlipModal()"};
let curPage = 'dashboard';

function nav(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
  document.getElementById('topbarTitle').textContent = pageTitles[id]||id;
  const ab = document.getElementById('topAddBtn');
  if(addBtnLabels[id]){ ab.textContent=addBtnLabels[id]; ab.setAttribute('onclick', addBtnFns[id]); ab.style.display=''; }
  else ab.style.display='none';
  curPage = id;
  const renders = {dashboard:renderDash,transactions:renderTx,invoices:renderInv,taxinvoice:renderTax,receipts:renderRec,slips:renderSlips,report:renderReport};
  if(renders[id]) renders[id]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeM(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }));
function toast(msg,type='ok'){
  const t=document.createElement('div'); t.className='toast toast-'+type; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash(){
  const inc = DB.tx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp = DB.tx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const pend = DB.inv.filter(i=>i.status==='pending').reduce((s,i)=>s+i.amount,0);
  document.getElementById('statGrid').innerHTML = `
    <div class="stat-card stat-income"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div><div class="stat-val">${fmt(inc)}</div><div class="stat-sub">${DB.tx.filter(t=>t.type==='income').length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
    <div class="stat-card stat-expense"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div class="stat-val">${fmt(exp)}</div><div class="stat-sub">${DB.tx.filter(t=>t.type==='expense').length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
    <div class="stat-card stat-balance"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="stat-val">${fmt(inc-exp)}</div><div class="stat-sub">‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div></div>
    <div class="stat-card stat-pending"><div class="stat-label">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</div><div class="stat-val">${fmt(pend)}</div><div class="stat-sub">${DB.inv.filter(i=>i.status==='pending').length} ‡πÉ‡∏ö</div></div>
  `;
  document.getElementById('recentRows').innerHTML = DB.tx.slice(0,8).map(t=>`
    <tr>
      <td>${t.date}</td><td><b>${t.desc}</b></td>
      <td><span class="badge ${t.type==='income'?'b-income':'b-expense'}">${t.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td>
      <td style="color:var(--gray-400);font-size:12px">${t.cat}</td>
      <td class="mono ${t.type==='income'?'c-green':'c-red'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
    </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--gray-400);padding:32px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTxCats(){
  const t=document.getElementById('f-type').value;
  document.getElementById('f-cat').innerHTML=(t==='income'?incomeCats:expenseCats).map(c=>`<option>${c}</option>`).join('');
}
function openTxModal(){ document.getElementById('f-date').value=today(); updateTxCats(); document.getElementById('txModal').classList.add('open'); }
function saveTx(){
  const t={id:uid(),date:document.getElementById('f-date').value,type:document.getElementById('f-type').value,desc:document.getElementById('f-desc').value,cat:document.getElementById('f-cat').value,amount:parseFloat(document.getElementById('f-amount').value)||0,ref:document.getElementById('f-ref').value};
  if(!t.desc||!t.amount){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  DB.tx.unshift(t); save(); closeM('txModal');
  ['f-desc','f-amount','f-ref'].forEach(id=>document.getElementById(id).value='');
  toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); renderTx(); renderDash();
}
function renderTx(){
  const q=(document.getElementById('txQ')?.value||'').toLowerCase();
  const tf=document.getElementById('txType')?.value||'';
  const cf=document.getElementById('txCat')?.value||'';
  const allCats=[...new Set(DB.tx.map(t=>t.cat))];
  const sel=document.getElementById('txCat');
  if(sel) sel.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>'+allCats.map(c=>`<option ${c===cf?'selected':''}>${c}</option>`).join('');
  const list=DB.tx.filter(t=>(!q||(t.desc+t.ref+t.cat).toLowerCase().includes(q))&&(!tf||t.type===tf)&&(!cf||t.cat===cf));
  document.getElementById('txRows').innerHTML=list.map(t=>`
    <tr>
      <td>${t.date}</td><td><b>${t.desc}</b></td>
      <td style="font-size:12px;color:var(--gray-400)">${t.cat}</td>
      <td><span class="badge ${t.type==='income'?'b-income':'b-expense'}">${t.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td>
      <td style="font-size:12px;color:var(--gray-400)">${t.ref||'-'}</td>
      <td class="mono ${t.type==='income'?'c-green':'c-red'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
      <td><button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delTx('${t.id}')">‚úï</button></td>
    </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
function delTx(id){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; DB.tx=DB.tx.filter(t=>t.id!==id); save(); renderTx(); renderDash(); toast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
function exportTxCSV(){
  if(!DB.tx.length){ toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','err'); return; }
  const h='‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏´‡∏°‡∏ß‡∏î,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô,‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á';
  const r=DB.tx.map(t=>[t.date,t.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',t.desc,t.cat,t.amount,t.ref||''].map(v=>`"${v}"`).join(','));
  dlCSV('\uFEFF'+h+'\n'+r.join('\n'),'TCDA_Transactions_'+today());
}
function importTxCSV(input){
  readCSV(input,lines=>{
    let n=0;
    lines.slice(1).forEach((ln,i)=>{
      if(!ln.trim()) return;
      const c=parseCSV(ln); // date,type,desc,cat,amount,ref
      const amt=parseFloat((c[4]||'0').replace(/,/g,''));
      if(!c[0]||!c[2]||!amt) return;
      DB.tx.unshift({id:uid(),date:c[0].trim(),type:(c[1]||'').includes('‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö')||c[1]==='income'?'income':'expense',desc:(c[2]||'').trim(),cat:(c[3]||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ').trim(),amount:amt,ref:(c[5]||'').trim()});
      n++;
    });
    save(); renderTx(); renderDash(); toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${n} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVOICES (Flow-style wizard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let invStepIdx = 0;
function openInvWizard(){
  invStepIdx=0;
  document.getElementById('inv-no').value=seq(DB.inv,'INV');
  document.getElementById('inv-date').value=today();
  const d=new Date(); d.setDate(d.getDate()+30);
  document.getElementById('inv-due').value=d.toISOString().split('T')[0];
  ['inv-to','inv-item','inv-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('inv-amount').value='';
  setInvStep(0);
  document.getElementById('invModal').classList.add('open');
}
function setInvStep(s){
  invStepIdx=s;
  [0,1,2].forEach(i=>{
    const p=document.getElementById('inv-s'+i); if(p) p.style.display=i===s?'':'none';
    const st=document.querySelector(`#invSteps [data-s="${i}"]`);
    if(st){ st.className='step'; if(i<s) st.classList.add('done'); if(i===s) st.classList.add('active'); }
  });
  document.getElementById('invBack').style.visibility=s>0?'':'hidden';
  document.getElementById('invNext').textContent=s<2?'‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí':'‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Invoice';
  if(s===2){
    document.getElementById('inv-preview-mini').innerHTML=`
      <div style="margin-bottom:6px"><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</b> ${document.getElementById('inv-no').value}</div>
      <div style="margin-bottom:6px"><b>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</b> ${document.getElementById('inv-to').value}</div>
      <div style="margin-bottom:6px"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${document.getElementById('inv-date').value} &nbsp;|&nbsp; <b>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</b> ${document.getElementById('inv-due').value}</div>
      <div style="margin-bottom:6px"><b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</b> ${document.getElementById('inv-item').value}</div>
      <div style="font-size:20px;font-weight:700;color:var(--navy);font-family:'JetBrains Mono',monospace;margin-top:8px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${fmt(document.getElementById('inv-amount').value)}</div>
    `;
  }
}
function invStep(dir){
  if(dir===1 && invStepIdx===2){ saveInv(); return; }
  setInvStep(invStepIdx+dir);
}
function saveInv(){
  const inv={id:uid(),no:document.getElementById('inv-no').value,date:document.getElementById('inv-date').value,due:document.getElementById('inv-due').value,to:document.getElementById('inv-to').value,item:document.getElementById('inv-item').value,amount:parseFloat(document.getElementById('inv-amount').value)||0,status:document.getElementById('inv-status').value,note:document.getElementById('inv-note').value};
  if(!inv.to||!inv.amount){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  DB.inv.unshift(inv); save(); closeM('invModal'); toast('‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); renderInv(); renderDash();
}
function renderInv(){
  const q=(document.getElementById('invQ')?.value||'').toLowerCase();
  const sf=document.getElementById('invStatus')?.value||'';
  const list=DB.inv.filter(i=>(!q||(i.to+i.no+i.item).toLowerCase().includes(q))&&(!sf||i.status===sf));
  document.getElementById('invRows').innerHTML=list.map(i=>`
    <tr>
      <td class="mono" style="font-size:11.5px">${i.no}</td><td>${i.date}</td><td><b>${i.to}</b></td><td>${i.item}</td>
      <td><span class="badge ${i.status==='paid'?'b-paid':i.status==='pending'?'b-pending':'b-draft'}">${i.status==='paid'?'‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß':i.status==='pending'?'‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞':'‡∏£‡πà‡∏≤‡∏á'}</span></td>
      <td class="mono c-green">${fmt(i.amount)}</td>
      <td style="display:flex;gap:4px">
        <button class="btn btn-ghost btn-xs" onclick="viewInv('${i.id}')">üëÅÔ∏è</button>
        ${i.status!=='paid'?`<button class="btn btn-success btn-xs" onclick="markInvPaid('${i.id}')">‚úì ‡∏ä‡∏≥‡∏£‡∏∞</button>`:''}
        <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delInv('${i.id}')">‚úï</button>
      </td>
    </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
function markInvPaid(id){ const i=DB.inv.find(x=>x.id===id); if(i){i.status='paid'; save(); renderInv(); renderDash(); toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß');} }
function delInv(id){ if(!confirm('‡∏•‡∏ö?')) return; DB.inv=DB.inv.filter(i=>i.id!==id); save(); renderInv(); renderDash(); }
function exportInvCSV(){
  const h='‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
  const r=DB.inv.map(i=>[i.no,i.date,i.to,i.item,i.status,i.amount].map(v=>`"${v}"`).join(','));
  dlCSV('\uFEFF'+h+'\n'+r.join('\n'),'TCDA_Invoices_'+today());
}
function viewInv(id){
  const i=DB.inv.find(x=>x.id===id); if(!i) return;
  const isPaid=i.status==='paid';
  document.getElementById('docViewContent').innerHTML=buildInvHTML(i,'INVOICE','‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',isPaid);
  document.getElementById('docViewModal').classList.add('open');
}
function buildInvHTML(doc,typeEn,typeTh,paid){
  return `<div class="inv-preview">
    <div class="inv-header">
      <div><div class="inv-org-name">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</div>
      <div class="inv-org-detail">Thailand Choral Directors Association<br>‡πÇ‡∏ó‡∏£/‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏Ø</div></div>
      <div class="inv-doc-type">
        <div class="inv-doc-label">${typeEn}</div>
        <div class="inv-doc-label-th">${typeTh}</div>
        <div class="inv-doc-no">${doc.no||doc.id}</div>
        ${paid?'<div style="margin-top:8px"><span style="background:var(--green);color:white;font-size:11px;font-weight:700;padding:3px 12px;border-radius:4px">PAID ‚úì</span></div>':''}
      </div>
    </div>
    <div class="inv-body">
      <div class="inv-meta">
        <div class="inv-meta-box"><div class="inv-meta-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div><div class="inv-meta-val">${doc.to||doc.from}</div></div>
        <div class="inv-meta-box"><div class="inv-meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="inv-meta-val">${doc.date}</div>${doc.due?`<div class="inv-meta-val-sm" style="margin-top:4px">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <b style="color:var(--red)">${doc.due}</b></div>`:''}</div>
      </div>
      <div class="inv-items">
        <table><thead><tr><th>#</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="mono" style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
        <tbody><tr><td>1</td><td>${doc.item||doc.desc}</td><td class="mono" style="text-align:right">${fmt(doc.amount)}</td></tr></tbody></table>
      </div>
      <div class="inv-totals"><div class="inv-totals-box">
        <div class="inv-tot-row total-final"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="amt">${fmt(doc.amount)}</span></div>
      </div></div>
      ${doc.note?`<div class="inv-note-box">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${doc.note}</div>`:''}
      <div class="inv-footer">
        <div class="inv-sig-box"><div class="inv-sig-line"></div><div class="inv-sig-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Authorized Signature</div></div>
        <div class="inv-sig-box" style="text-align:center;padding-top:12px">${paid?'<div class="inv-stamp">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>':''}</div>
        <div class="inv-sig-box"><div class="inv-sig-line"></div><div class="inv-sig-label">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô / Payer</div></div>
      </div>
    </div>
    <div style="background:var(--gray-100);padding:10px 32px;font-size:10.5px;color:var(--gray-400);display:flex;justify-content:space-between">
      <span>‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</span><span>‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö TCDA Finance v2</span>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAX INVOICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcVat(){
  const b=parseFloat(document.getElementById('tax-before').value)||0;
  const vat=b*0.07;
  document.getElementById('tax-vat').value=fmt(vat).replace('‡∏ø','');
  document.getElementById('tax-total').value=fmt(b+vat).replace('‡∏ø','');
}
function openTaxWizard(){
  document.getElementById('tax-no').value=seq(DB.tax,'TAX');
  document.getElementById('tax-date').value=today();
  const sid=document.getElementById('tax-seller-id');
  if(DB.cfg.sellerTaxId) sid.value=DB.cfg.sellerTaxId;
  ['tax-buyer','tax-buyer-id','tax-buyer-addr','tax-item','tax-before','tax-vat','tax-total'].forEach(id=>{const el=document.getElementById(id); if(el&&!el.readOnly) el.value='';});
  document.getElementById('taxModal').classList.add('open');
}
function saveTaxDoc(status){
  const before=parseFloat(document.getElementById('tax-before').value)||0;
  const vat=parseFloat((document.getElementById('tax-vat').value||'0').replace(/,/g,''))||before*0.07;
  const doc={id:uid(),no:document.getElementById('tax-no').value,date:document.getElementById('tax-date').value,sellerTaxId:document.getElementById('tax-seller-id').value,docType:document.getElementById('tax-doc-type').value,buyer:document.getElementById('tax-buyer').value,buyerId:document.getElementById('tax-buyer-id').value,buyerAddr:document.getElementById('tax-buyer-addr').value,item:document.getElementById('tax-item').value,before,vat,total:before+vat,status};
  if(!doc.buyer||!doc.before){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  if(document.getElementById('tax-seller-id').value) DB.cfg.sellerTaxId=document.getElementById('tax-seller-id').value;
  DB.tax.unshift(doc); save(); closeM('taxModal'); toast('‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); renderTax();
}
function renderTax(){
  const q=(document.getElementById('taxQ')?.value||'').toLowerCase();
  const sf=document.getElementById('taxStatus')?.value||'';
  const list=DB.tax.filter(t=>(!q||(t.buyer+t.no).toLowerCase().includes(q))&&(!sf||t.status===sf));
  document.getElementById('taxRows').innerHTML=list.map(t=>`
    <tr>
      <td class="mono" style="font-size:11.5px">${t.no}</td><td>${t.date}</td><td><b>${t.buyer}</b></td>
      <td class="mono" style="font-size:11.5px">${t.buyerId||'-'}</td>
      <td><span class="badge ${t.status==='issued'?'b-tax':'b-draft'}">${t.status==='issued'?'‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß':'‡∏£‡πà‡∏≤‡∏á'}</span></td>
      <td class="mono">${fmt(t.before)}</td><td class="mono c-gold">${fmt(t.vat)}</td><td class="mono" style="font-weight:700">${fmt(t.total)}</td>
      <td style="display:flex;gap:4px">
        <button class="btn btn-ghost btn-xs" onclick="viewTax('${t.id}')">üëÅÔ∏è</button>
        <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delTax('${t.id}')">‚úï</button>
      </td>
    </tr>`).join('') || '<tr><td colspan="9" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
function delTax(id){ if(!confirm('‡∏•‡∏ö?')) return; DB.tax=DB.tax.filter(t=>t.id!==id); save(); renderTax(); }
function exportTaxCSV(){
  const h='‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠,‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏Å‡πà‡∏≠‡∏ô VAT,VAT 7%,‡∏£‡∏ß‡∏°,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
  const r=DB.tax.map(t=>[t.no,t.date,t.buyer,t.buyerId||'',t.item,t.before,t.vat,t.total,t.status].map(v=>`"${v}"`).join(','));
  dlCSV('\uFEFF'+h+'\n'+r.join('\n'),'TCDA_TaxInvoice_'+today());
}
function viewTax(id){
  const t=DB.tax.find(x=>x.id===id); if(!t) return;
  document.getElementById('docViewContent').innerHTML=buildTaxHTML(t);
  document.getElementById('docViewModal').classList.add('open');
}
function buildTaxHTML(t){
  const isShort=t.docType==='short';
  return `<div class="inv-preview">
    <div class="inv-header">
      <div>
        <div class="inv-org-name">‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</div>
        <div class="inv-org-detail">Thailand Choral Directors Association<br>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${t.sellerTaxId||'- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ -'}</div>
      </div>
      <div class="inv-doc-type">
        <div class="inv-doc-label">${isShort?'TAX INVOICE (ABB.)':'TAX INVOICE'}</div>
        <div class="inv-doc-label-th">${isShort?'‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠':'‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö'}</div>
        <div class="inv-doc-no">${t.no}</div>
      </div>
    </div>
    <div class="inv-body">
      <div class="inv-meta">
        <div class="inv-meta-box">
          <div class="inv-meta-label">‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠ / Buyer</div>
          <div class="inv-meta-val">${t.buyer}</div>
          <div class="inv-meta-val-sm" style="margin-top:4px">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${t.buyerId||'-'}</div>
          <div class="inv-meta-val-sm">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${t.buyerAddr||'-'}</div>
        </div>
        <div class="inv-meta-box"><div class="inv-meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</div><div class="inv-meta-val">${t.date}</div></div>
      </div>
      <div class="inv-items">
        <table><thead><tr><th>#</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / Description</th><th class="mono" style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
        <tbody><tr><td>1</td><td>${t.item}</td><td class="mono" style="text-align:right">${fmt(t.before)}</td></tr></tbody></table>
      </div>
      <div class="inv-totals"><div class="inv-totals-box">
        <div class="inv-tot-row"><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</span><span class="amt">${fmt(t.before)}</span></div>
        <div class="inv-tot-row" style="color:var(--gold)"><span>‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%</span><span class="amt">${fmt(t.vat)}</span></div>
        <div class="inv-tot-row total-final"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="amt">${fmt(t.total)}</span></div>
      </div></div>
      ${!isShort?`<div class="inv-footer">
        <div class="inv-sig-box"><div class="inv-sig-line"></div><div class="inv-sig-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / Authorized</div></div>
        <div></div>
        <div class="inv-sig-box"><div class="inv-sig-line"></div><div class="inv-sig-label">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô / Payer</div></div>
      </div>`:''}
    </div>
    <div style="background:var(--gray-100);padding:10px 32px;font-size:10.5px;color:var(--gray-400);display:flex;justify-content:space-between">
      <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö TCDA Finance</span><span>VAT Reg. ${t.sellerTaxId||'-'}</span>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECEIPTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openRecWizard(){ document.getElementById('rec-no').value=seq(DB.rec,'REC'); document.getElementById('rec-date').value=today(); document.getElementById('recModal').classList.add('open'); }
function saveRec(){
  const r={id:uid(),no:document.getElementById('rec-no').value,date:document.getElementById('rec-date').value,from:document.getElementById('rec-from').value,item:document.getElementById('rec-item').value,amount:parseFloat(document.getElementById('rec-amount').value)||0,method:document.getElementById('rec-method').value,note:document.getElementById('rec-note').value};
  if(!r.from||!r.amount){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  DB.rec.unshift(r); save(); closeM('recModal'); toast('‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); renderRec();
}
function renderRec(){
  const q=(document.getElementById('recQ')?.value||'').toLowerCase();
  const list=DB.rec.filter(r=>!q||(r.from+r.no+r.item).toLowerCase().includes(q));
  document.getElementById('recRows').innerHTML=list.map(r=>`
    <tr>
      <td class="mono" style="font-size:11.5px">${r.no}</td><td>${r.date}</td><td><b>${r.from}</b></td><td>${r.item}</td>
      <td class="mono c-green">${fmt(r.amount)}</td>
      <td style="display:flex;gap:4px">
        <button class="btn btn-ghost btn-xs" onclick="viewRec('${r.id}')">üëÅÔ∏è</button>
        <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delRec('${r.id}')">‚úï</button>
      </td>
    </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
function delRec(id){ if(!confirm('‡∏•‡∏ö?')) return; DB.rec=DB.rec.filter(r=>r.id!==id); save(); renderRec(); }
function viewRec(id){
  const r=DB.rec.find(x=>x.id===id); if(!r) return;
  document.getElementById('docViewContent').innerHTML=buildInvHTML({...r,to:r.from,due:null,note:r.note},'RECEIPT','‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',true);
  document.getElementById('docViewModal').classList.add('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SLIPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSlipModal(){ document.getElementById('sl-date').value=today(); document.getElementById('slipModal').classList.add('open'); }
function saveSlip(){
  const s={id:uid(),no:seq(DB.slip,'SLP'),date:document.getElementById('sl-date').value,from:document.getElementById('sl-from').value,desc:document.getElementById('sl-desc').value,ref:document.getElementById('sl-ref').value,bank:document.getElementById('sl-bank').value,amount:parseFloat(document.getElementById('sl-amount').value)||0};
  if(!s.from||!s.amount){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  DB.slip.unshift(s); save(); closeM('slipModal'); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slip ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); renderSlips();
}
function renderSlips(){
  const q=(document.getElementById('slipQ')?.value||'').toLowerCase();
  const list=DB.slip.filter(s=>!q||(s.from+s.desc+s.ref).toLowerCase().includes(q));
  const lbl=document.getElementById('slipCountLbl');
  if(lbl) lbl.textContent=`${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${DB.slip.length})`;
  document.getElementById('slipGrid').innerHTML=list.map(s=>`
    <div class="slip-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <span class="slip-no">${s.no}</span>
        <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delSlip('${s.id}')">‚úï</button>
      </div>
      <div class="slip-amt">${fmt(s.amount)}</div>
      <div class="slip-from">${s.from}</div>
      <div class="slip-meta">${s.date} ¬∑ ${s.bank}</div>
      ${s.desc?`<div class="slip-meta" style="margin-top:4px">${s.desc}</div>`:''}
      ${s.ref?`<div class="slip-meta mono" style="margin-top:3px;font-size:10.5px">Ref: ${s.ref}</div>`:''}
    </div>`).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--gray-400);padding:48px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Slip</div>';
}
function delSlip(id){ if(!confirm('‡∏•‡∏ö?')) return; DB.slip=DB.slip.filter(s=>s.id!==id); save(); renderSlips(); }
function dlSlipTemplate(){
  const c='\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD),‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á,‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£\n2025-03-01,‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ,1500,‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å 2568,2503010001,‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)\n2025-03-02,‡∏î‡∏£.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏û‡∏•‡∏á,3000,‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô,,‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)';
  dlCSV(c,'TCDA_Slip_Template');
}
function importSlips(input){
  readCSV(input,lines=>{
    let n=0;
    lines.slice(1).forEach(ln=>{
      if(!ln.trim()) return;
      const c=parseCSV(ln);
      const amt=parseFloat((c[2]||'0').replace(/,/g,''));
      if(!c[0]||!c[1]||!amt) return;
      DB.slip.unshift({id:uid(),no:seq(DB.slip,'SLP'),date:c[0].trim(),from:c[1].trim(),amount:amt,desc:(c[3]||'').trim(),ref:(c[4]||'').trim(),bank:(c[5]||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ').trim()});
      n++;
    });
    save(); renderSlips(); toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Slip ${n} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  });
}
function exportSlips(){
  if(!DB.slip.length){ toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','err'); return; }
  const h='‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á,‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
  const r=DB.slip.map(s=>[s.no,s.date,s.from,s.amount,s.desc,s.ref||'',s.bank].map(v=>`"${v}"`).join(','));
  dlCSV('\uFEFF'+h+'\n'+r.join('\n'),'TCDA_Slips_'+today());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE SHEETS IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function importFromGSheet(type){
  const urlId=type==='tx'?'gsTxUrl':'gsSlipUrl';
  const url=document.getElementById(urlId).value.trim();
  if(!url){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Sheet','err'); return; }
  toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...');
  try{
    // We fetch via a CORS proxy approach - for GitHub Pages use Apps Script instead
    const r=await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const text=await r.text();
    const lines=text.trim().split('\n');
    if(type==='tx'){
      let n=0;
      lines.slice(1).forEach(ln=>{
        if(!ln.trim()) return;
        const c=parseCSV(ln);
        const amt=parseFloat((c[4]||'0').replace(/,/g,''));
        if(!c[0]||!c[2]||!amt) return;
        DB.tx.unshift({id:uid(),date:c[0].trim(),type:(c[1]||'').includes('‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö')||c[1]==='income'?'income':'expense',desc:(c[2]||'').trim(),cat:(c[3]||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ').trim(),amount:amt,ref:(c[5]||'').trim()});
        n++;
      });
      save(); renderTx(); renderDash(); toast(`‚úÖ Import ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ${n} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å Google Sheets`);
    } else {
      let n=0;
      lines.slice(1).forEach(ln=>{
        if(!ln.trim()) return;
        const c=parseCSV(ln);
        const amt=parseFloat((c[2]||'0').replace(/,/g,''));
        if(!c[0]||!c[1]||!amt) return;
        DB.slip.unshift({id:uid(),no:seq(DB.slip,'SLP'),date:c[0].trim(),from:c[1].trim(),amount:amt,desc:(c[3]||'').trim(),ref:(c[4]||'').trim(),bank:(c[5]||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ').trim()});
        n++;
      });
      save(); renderSlips(); toast(`‚úÖ Import Slips ${n} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å Google Sheets`);
    }
    document.getElementById('gsBadge').textContent='‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß'; document.getElementById('gsBadge').className='gsheet-status gs-connected';
    document.getElementById('gsStatusText').textContent='‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß';
    if(DB.cfg) { DB.cfg[urlId]=url; save(); }
  } catch(e){
    toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ: '+e.message+' ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Sheet ‡∏ñ‡∏π‡∏Å Publish to Web ‡πÅ‡∏•‡πâ‡∏ß','err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReport(){
  const inc=DB.tx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=DB.tx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  document.getElementById('rStatGrid').innerHTML=`
    <div class="stat-card stat-income"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∞‡∏™‡∏°</div><div class="stat-val">${fmt(inc)}</div></div>
    <div class="stat-card stat-expense"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div><div class="stat-val">${fmt(exp)}</div></div>
    <div class="stat-card stat-balance"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="stat-val">${fmt(inc-exp)}</div></div>`;
  const incMap={},expMap={};
  DB.tx.forEach(t=>{ const m=t.type==='income'?incMap:expMap; m[t.cat]=(m[t.cat]||0)+t.amount; });
  const maxInc=Math.max(...Object.values(incMap),1);
  const maxExp=Math.max(...Object.values(expMap),1);
  document.getElementById('incomeChart').innerHTML=Object.entries(incMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="bar-row"><span class="bar-label">${k}</span><div class="bar-track"><div class="bar-fill bar-income-fill" style="width:${v/maxInc*100}%"></div></div><span class="bar-amt c-green">${fmt(v)}</span></div>`).join('')||'<div style="color:var(--gray-400);font-size:13px;padding:8px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  document.getElementById('expenseChart').innerHTML=Object.entries(expMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="bar-row"><span class="bar-label">${k}</span><div class="bar-track"><div class="bar-fill bar-expense-fill" style="width:${v/maxExp*100}%"></div></div><span class="bar-amt c-red">${fmt(v)}</span></div>`).join('')||'<div style="color:var(--gray-400);font-size:13px;padding:8px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  const catMap={};
  DB.tx.forEach(t=>{ const k=t.cat+'_'+t.type; if(!catMap[k]) catMap[k]={cat:t.cat,type:t.type,count:0,total:0}; catMap[k].count++; catMap[k].total+=t.amount; });
  document.getElementById('reportRows').innerHTML=Object.values(catMap).sort((a,b)=>b.total-a.total).map(r=>`<tr><td>${r.cat}</td><td><span class="badge ${r.type==='income'?'b-income':'b-expense'}">${r.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</span></td><td>${r.count}</td><td class="mono ${r.type==='income'?'c-green':'c-red'}">${fmt(r.total)}</td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--gray-400);padding:32px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function printDoc(){ window.print(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dlCSV(csv,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download=name+'.csv'; a.click(); }
function parseCSV(line){ const r=[]; let c='',q=false; for(const ch of line){ if(ch==='"'){q=!q}else if(ch===','&&!q){r.push(c);c=''}else c+=ch; } r.push(c); return r.map(v=>v.trim().replace(/^"|"$/g,'')); }
function readCSV(input,cb){ const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>cb(e.target.result.replace(/^\uFEFF/,'').split('\n')); r.readAsText(f,'UTF-8'); input.value=''; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEED + INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seed(){
  if(DB.tx.length) return;
  DB.tx=[
    {id:'s1',date:'2025-01-15',type:'income',desc:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568',cat:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',amount:1500,ref:'TRF001'},
    {id:'s2',date:'2025-01-20',type:'income',desc:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° Choral Workshop',cat:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏°',amount:3000,ref:'TRF002'},
    {id:'s3',date:'2025-02-01',type:'expense',desc:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',cat:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',amount:5000,ref:''},
    {id:'s4',date:'2025-02-10',type:'income',desc:'‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏™‡∏°‡∏≤‡∏Ñ‡∏°',cat:'‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ',amount:10000,ref:'DON001'},
    {id:'s5',date:'2025-02-15',type:'expense',desc:'‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',cat:'‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£',amount:8000,ref:''},
  ];
  DB.inv=[
    {id:'i1',no:'INV-2025-0001',date:'2025-01-10',due:'2025-02-10',to:'‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ',item:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568',amount:1500,status:'paid',note:''},
    {id:'i2',no:'INV-2025-0002',date:'2025-02-01',due:'2025-03-01',to:'‡∏î‡∏£.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏û‡∏•‡∏á',item:'‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° Choral Conducting',amount:3000,status:'pending',note:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏ö‡∏£‡∏°'},
  ];
  DB.slip=[{id:'sl1',no:'SLP-2025-0001',date:'2025-01-15',from:'‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ',desc:'‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å 2568',ref:'2501150001',bank:'‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)',amount:1500}];
  save();
}
seed();
renderDash();
</script>
</body>
</html>
